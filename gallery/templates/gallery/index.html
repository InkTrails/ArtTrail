<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ display_user.username }}ã®ã‚¢ãƒˆãƒªã‚¨ - ArtTrail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top { height: 200px; object-fit: cover; } /* ç”»åƒé«˜ã•çµ±ä¸€*/
        .sidebar-icon { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; background-color: #eee; } /* ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¸¸ã */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; } /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å››è§’ã« */
        .calendar-cell { aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; font-size: 10px; border-radius: 4px; } /* ãƒã‚¹ã‚’æ­£æ–¹å½¢ã« */
    </style>
</head>
<body class="bg-light pb-5">

    <nav class="navbar navbar-white bg-white shadow-sm mb-4">
        <div class="container">
            <a href="/" class="navbar-brand fw-bold fs-3 text-dark text-decoration-none">ğŸ¨ ArtTrail</a>
            <span class="navbar-text small">
                {% if user.is_authenticated %} <!-- ãƒ¦ãƒ¼ã‚¶ã®è³‡æ ¼ã‚’è¡¨ç¤º -->
                    ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {{ user.username }}
                {% else %}
                    ğŸ‘€ ã‚²ã‚¹ãƒˆé–²è¦§ä¸­
                {% endif %}
            </span>
            <div class="ms-auto">
                {% if user.is_authenticated %}
                    <form action="{% url 'logout' %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-sm btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</a>
                    <a href="{% url 'signup' %}" class="btn btn-sm btn-success">æ–°è¦ç™»éŒ²</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            
            <div class="col-md-3">
                
                <div class="card border-0 shadow-sm p-3 mb-3 text-center">
                    <div class="mb-2 position-relative d-inline-block">
                        {% if display_user.userprofile.avatar %}
                            <img src="{{ display_user.userprofile.avatar.url }}" class="sidebar-icon border" alt="icon">
                        {% else %}
                            <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" class="sidebar-icon border" alt="icon">
                        {% endif %}
                        
                        {% if user == display_user %}
                        <a href="{% url 'profile_edit' %}" class="position-absolute bottom-0 end-0 bg-white border rounded-circle p-1 text-dark shadow-sm" style="width: 24px; height: 24px; line-height: 1; font-size: 14px; text-decoration: none;" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†">âš™ï¸</a>
                        {% endif %}
                    </div>

                    <h5 class="fw-bold mb-0">{{ display_user.username }}</h5>
                    
                    <p class="text-muted small mt-1 mb-2">
                        
                        {% if display_user.userprofile.bio %}  <!-- bioè¡¨ç¤º -->
                            {{ display_user.userprofile.bio|linebreaksbr }}
                        {% endif %}
                    </p>

                    {% if user == display_user %}
                        <div class="d-grid gap-2 mt-3">
                            <a href="{% url 'upload' %}" class="btn btn-primary btn-sm fw-bold">ï¼‹ æ–°ã—ã„çµµã‚’æŠ•ç¨¿</a>
                            <button onclick="copyShareUrl()" class="btn btn-outline-secondary btn-sm">ğŸ”— ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªURLã‚’ã‚³ãƒ”ãƒ¼</button>
                        </div>
                    {% endif %}
                </div>

                <div class="card border-0 shadow-sm p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <a href="?year={{ prev_year }}&month={{ prev_month }}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}" class="btn btn-sm btn-light border">â—€</a>
                        <span class="fw-bold small">{{ current_year }}å¹´ {{ current_month }}æœˆ</span>
                        <a href="?year={{ next_year }}&month={{ next_month }}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}" class="btn btn-sm btn-light border">â–¶</a>
                    </div>

                    <div class="calendar-grid text-center mb-1">
                        <small class="text-danger" style="font-size:10px">æ—¥</small>
                        <small class="text-muted" style="font-size:10px">æœˆ</small>
                        <small class="text-muted" style="font-size:10px">ç«</small>
                        <small class="text-muted" style="font-size:10px">æ°´</small>
                        <small class="text-muted" style="font-size:10px">æœ¨</small>
                        <small class="text-muted" style="font-size:10px">é‡‘</small>
                        <small class="text-primary" style="font-size:10px">åœŸ</small>
                    </div>

                    <div class="calendar-grid">
                        {% for cell in calendar_data %}
                            {% if cell.is_empty %}
                                <div></div> 
                            {% else %}
                                <div class="calendar-cell border {{ cell.color }}" 
                                    title="{{ cell.date|date:'Y/m/d' }}: {{ cell.count }}æšæŠ•ç¨¿">
                                    {{ cell.day }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="mb-4 d-flex gap-2 flex-wrap">
                    <a href="?{% if request.GET.user %}user={{ request.GET.user }}{% endif %}" class="btn btn-dark rounded-pill px-4 btn-sm">ALL</a>
                    <a href="?tag=hand{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}" class="btn btn-outline-dark rounded-pill px-3 btn-sm">æ‰‹</a>
                    <a href="?tag=face{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}" class="btn btn-outline-dark rounded-pill px-3 btn-sm">é¡”</a>
                    <a href="?tag=pose{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}" class="btn btn-outline-dark rounded-pill px-3 btn-sm">ãƒãƒ¼ã‚º</a>
                    <a href="?tag=copy{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}" class="btn btn-outline-dark rounded-pill px-3 btn-sm">æ¨¡å†™</a>
                </div>

                <div class="row g-3">
                    {% for post in posts %}
                    <div class="col-md-4 col-sm-6">
                        <div class="card border-0 shadow-sm h-100 position-relative">
                            
                            {% if user == post.author %}
                            <div class="position-absolute top-0 end-0 m-2 z-3">
                                <input type="checkbox" class="form-check-input border-2 compare-check shadow" value="{{ post.id }}" style="transform: scale(1.3); cursor: pointer;">
                            </div>
                            {% else %}
                            <div class="position-absolute top-0 end-0 m-2 z-3">
                                <input type="checkbox" class="form-check-input border-2 compare-check shadow" value="{{ post.id }}" style="transform: scale(1.3); cursor: pointer;">
                            </div>
                            {% endif %}

                            {% if post.image %}
                                <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.title }}">
                            {% else %}
                                <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center text-white">No Image</div>
                            {% endif %}

                            <div class="card-body p-2">
                                <h6 class="card-title fw-bold mb-1">{{ post.title }}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">{{ post.created_at|date:"m/d" }}</small>
                                    {% if post.is_practice %}
                                        <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">æ¨¡å†™</span>
                                    {% else %}
                                        <span class="badge bg-primary" style="font-size: 0.7rem;">Orig</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                        <div class="col-12 text-center py-5">
                            <p class="text-muted">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“... ğŸ¨</p>
                        </div>
                    {% endfor %}
                </div>

                {% if posts.has_other_pages %}
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if posts.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ posts.previous_page_number }}{% if tag_slug %}&tag={{ tag_slug }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}">å‰ã¸</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">å‰ã¸</span></li>
                        {% endif %}
                        <li class="page-item active">
                            <span class="page-link">{{ posts.number }}</span>
                        </li>
                        {% if posts.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ posts.next_page_number }}{% if tag_slug %}&tag={{ tag_slug }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}">æ¬¡ã¸</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">æ¬¡ã¸</span></li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div> 
    </div>

    <div id="action-bar" class="fixed-bottom bg-dark text-white p-3 shadow-lg d-none">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="fw-bold">
                <span id="count">0</span>æš é¸æŠä¸­
            </span>
            <div class="d-flex gap-2">
                <form action="{% url 'bulk_delete' %}" method="post" id="delete-form" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                    {% csrf_token %}
                    <div id="delete-inputs"></div>
                    <button type="submit" id="delete-btn" class="btn btn-danger fw-bold" disabled>ğŸ—‘ï¸ ä¸€æ‹¬å‰Šé™¤</button>
                </form>
                <button id="compare-btn" class="btn btn-primary fw-bold" disabled>âš”ï¸ æ¯”è¼ƒã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        const checkboxes = document.querySelectorAll('.compare-check');
        const actionBar = document.getElementById('action-bar');
        const countSpan = document.getElementById('count');
        const compareBtn = document.getElementById('compare-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const deleteInputs = document.getElementById('delete-inputs');
        let selectedIds = [];

        // å…±æœ‰URLã‚³ãƒ”ãƒ¼
        function copyShareUrl() {
            const shareUrl = `${window.location.origin}/?user={{ user.username }}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('å…±æœ‰ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\n' + shareUrl);
            }).catch(err => {
                prompt("ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:", shareUrl);
            });
        }

        const currentUsername = "{{ user.username }}";
        const displayUsername = "{{ display_user.username }}";

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ“ä½œ
        checkboxes.forEach(chk => {
            chk.addEventListener('change', function() {
                const id = this.value;
                if (this.checked) {
                    selectedIds.push(id);
                } else {
                    selectedIds = selectedIds.filter(item => item !== id);
                }
                //ã€€ãƒãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡
                countSpan.innerText = selectedIds.length;
                if (selectedIds.length > 0) {
                    actionBar.classList.remove('d-none');
                    // ä»–äººã®ãƒšãƒ¼ã‚¸ãªã‚‰å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                    if (currentUsername === displayUsername) {
                        deleteBtn.disabled = false;
                        deleteBtn.style.display = 'inline-block';
                    } else {
                        deleteBtn.disabled = true;
                        deleteBtn.style.display = 'none';
                    }
                } else {
                    actionBar.classList.add('d-none');
                    deleteBtn.disabled = true;
                }
                //ã€€æ¯”è¼ƒãƒœã‚¿ãƒ³ã¯ï¼’æšé¸æŠæ™‚ã®ã¿
                if (selectedIds.length === 2) {
                    compareBtn.disabled = false;
                    compareBtn.classList.remove('btn-secondary');
                    compareBtn.classList.add('btn-primary');
                } else {
                    compareBtn.disabled = true;
                    compareBtn.classList.remove('btn-primary');
                    compareBtn.classList.add('btn-secondary');
                }
                deleteInputs.innerHTML = '';
                selectedIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'delete_ids';
                    input.value = id;
                    deleteInputs.appendChild(input);
                });
            });
        });
        compareBtn.addEventListener('click', function() { // æ¯”è¼ƒãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
            if (selectedIds.length === 2) {
                window.location.href = `/compare/?id1=${selectedIds[0]}&id2=${selectedIds[1]}`;
            }
        });
    </script>
</body>
</html>